<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Babylon.js sample code</title>
    <!-- Babylon.js -->
    <script src="http://www.babylonjs.com/hand.minified-1.2.js"></script>
    <script src="http://www.babylonjs.com/cannon.js"></script>
    <script src="http://www.babylonjs.com/oimo.js"></script>
    <script src="http://www.babylonjs.com/babylon.js"></script>
    
    <!-- jquery since javascript seems weak -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>
<body>
    <!--<div id="content"></div>-->
    <canvas id="renderCanvas"></canvas>
    <script>
        // Add ref. for intellisense to help us out:
        /// <reference path="http://www.babylonjs.com/babylon.js" />
        /// <reference path="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js" />

        // Read current weather data from file
        var text = "";
        var lastText = "";
        function readText(){
            var filePath = "/text.txt";
            jQuery.get(filePath, function (data) {
                //alert(data);
                text = data;
            });
        }

        //Declare engine and get canvas from DOM
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);

        // Global vars
        var camera;
        var skyboxMaterial;
        var scene;
        var particleSystem;


        // Create our environment
        function createScene() {
            scene = new BABYLON.Scene(engine);

            var light = new BABYLON.PointLight("Omni", new BABYLON.Vector3(10, 50, 50), scene);
            camera = new BABYLON.ArcRotateCamera("Camera", 0.4, 1.2, 20, new BABYLON.Vector3(-10, 0, 0), scene);
            x = camera.position.x;
            camera.attachControl(canvas, true);

            // Ground is mapped from heightmap, then covered with a grass texture
            var ground = BABYLON.Mesh.CreateGroundFromHeightMap("ground", "heightMap/Heightmap.jpg", 100, 100, 100, 0, 10, scene, false);
            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("textures/grass_texture.jpg", scene);
            groundMaterial.diffuseTexture.uScale = 6;
            groundMaterial.diffuseTexture.vScale = 6;
            groundMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            ground.position.y = -10;
            ground.material = groundMaterial;
            ground.receiveShadows = true;


            // Fog gives a nice ambiance 
            //scene.fogMode = BABYLON.Scene.FOGMODE_EXP;
            //BABYLON.Scene.FOGMODE_NONE;
            //BABYLON.Scene.FOGMODE_EXP;
            //BABYLON.Scene.FOGMODE_EXP2;
            scene.fogMode = BABYLON.Scene.FOGMODE_LINEAR;

            scene.fogColor = new BABYLON.Color3(0.9, 0.9, 0.85);
            scene.fogDensity = 0.01;

            //Only if LINEAR
            scene.fogStart = 27.0;
            scene.fogEnd = 90.0;
            

            // Skybox is a box with texture inside to give a 'world' feel
            var skybox = BABYLON.Mesh.CreateBox("skyBox", 100.0, scene);
            skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;

            //The billboard 
            outputplane = BABYLON.Mesh.CreatePlane("outputplane", 25, scene, false);
            outputplane.billboardMode = BABYLON.AbstractMesh.BILLBOARDMODE_ALL;
            outputplane.material = new BABYLON.StandardMaterial("outputplane", scene);
            outputplane.position = new BABYLON.Vector3(-25, -5, -25);
            outputplane.scaling.y = 0.4;

            outputplaneTexture = new BABYLON.DynamicTexture("dynamic texture", 412, scene, true);
            outputplane.material.diffuseTexture = outputplaneTexture;
            outputplane.material.specularColor = new BABYLON.Color3(0, 0, 0);
            outputplane.material.emissiveColor = new BABYLON.Color3(1, 1, 1);
            outputplane.material.backFaceCulling = false;

            context2D = outputplaneTexture.getContext();


            return scene;
        };
        // Create scene
        var scene = createScene();

        // Runs the rendering
        engine.runRenderLoop(function () {
            scene.render();
        });


        // The update method, used for updating camera etc.
        var x = 0;
        var counterForX = 0;
        var reduce = false;
        var lastRenderTime = 0;
        scene.beforeRender = function () {
            // Move camera for that good 3D feel
            if (camera.alpha >= 0.6) reduce = true;
            if (camera.alpha <= 0.4) reduce = false;
            if (reduce) camera.alpha -= 0.0002;
            if (!reduce) camera.alpha += 0.0002;

            // Get the current time
            var d = new Date();
            var timeNow = d.getTime();

            // Dont update more than every second
            if (timeNow - lastRenderTime > 1000) {
                lastRenderTime = timeNow;
                // Update the text
                readText();
                out("Current forecast:", text);

                // Dont update the entire system more than needed
                if (text != lastText) {
                    updateSystem();
                    lastText = text;
                }
            }
        };

        // Resize event
        window.addEventListener("resize", function () {
            engine.resize();
        });

        // Sets text to the billboard
        var out = function (data, data2) {
            context2D.clearRect(0, 0, 512, 512); // clear from(0,0) to (512,512)
            outputplaneTexture.drawText(data, null, 80, "40px verdana", "white", null);
            outputplaneTexture.drawText(data2, null, 160, "40px verdana", "white", null);
        }


        // Particle system used for displaying raindrops
        function setupParticleSystem(emitter) {
            // Create a particle system
            particleSystem = new BABYLON.ParticleSystem("particles", 2000, scene);

            //Texture of each particle
            particleSystem.particleTexture = new BABYLON.Texture("textures/raindrop2.gif", scene);

            // Where the particles come from
            particleSystem.emitter = emitter; // the starting object, the emitter
            particleSystem.minEmitBox = new BABYLON.Vector3(-1, 0, 0); // Starting all from
            particleSystem.maxEmitBox = new BABYLON.Vector3(1, 0, 0); // To...

            // Colors of all particles
            particleSystem.color1 = new BABYLON.Color4(0.7, 0.8, 1.0, 1.0);
            particleSystem.color2 = new BABYLON.Color4(0.2, 0.5, 1.0, 1.0);
            particleSystem.colorDead = new BABYLON.Color4(0, 0, 0.2, 0.0);

            // Size of each particle (random between...
            particleSystem.minSize = 0.1;
            particleSystem.maxSize = 0.5;

            // Life time of each particle (random between...
            particleSystem.minLifeTime = 0.3;
            particleSystem.maxLifeTime = 1.5;

            // Emission rate
            particleSystem.emitRate = 15;

            // Blend mode : BLENDMODE_ONEONE, or BLENDMODE_STANDARD
            particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;

            // Set the gravity of all particles
            particleSystem.gravity = new BABYLON.Vector3(0, -9.81, 0);

            // Direction of each particle after it has been emitted
            particleSystem.direction1 = new BABYLON.Vector3(-7, -8, 3);
            particleSystem.direction2 = new BABYLON.Vector3(7, -8, -3);

            // Angular speed, in radians
            particleSystem.minAngularSpeed = 0;
            particleSystem.maxAngularSpeed = 0;//Math.PI;

            // Speed
            particleSystem.minEmitPower = 0.1;
            particleSystem.maxEmitPower = 0.3;
            particleSystem.updateSpeed = 0.005;

            // Start the particle system
            particleSystem.start();
        }

        // Updates clouds, sun and rain according to forecast text
        var box = [];
        var sun;
        function updateSystem()
        {

            for (x = 0; x < 10; x++) {
                if (box[x] != null) box[x].dispose();
            }
            if (sun != null) sun.dispose();


            if (text == "Dark clouds" || text == "Rain") {
                var material1 = new BABYLON.StandardMaterial("mat1", scene);
                material1.diffuseColor = new BABYLON.Color3(0, 0, 0); // black clouds
                material1.specularColor = new BABYLON.Color3(1, 1, 1);
                material1.specularPower = 10;
            }
            if (text == "Light clouds") {
                var material1 = new BABYLON.StandardMaterial("mat1", scene);
                material1.diffuseColor = new BABYLON.Color3(1, 1, 1); // white clouds
                material1.specularColor = new BABYLON.Color3(1, 1, 1);
                material1.specularPower = 10;
            }

            if (text == "Light clouds" || text == "Dark clouds" || text == "Rain") {
                // boxes simulate clouds
                for (var i = 0; i < 10; i++) {
                    if (i <= 5) {
                        box[i] = BABYLON.Mesh.CreateBox("Box", 1.0 * i + 0.5, scene);
                        box[i].material = material1;
                        box[i].position = new BABYLON.Vector3(-i * 5 - 10, 3, 0);
                        if (text == "Rain") setupParticleSystem(box[i]); // Add raindrops if it's raining
                    }
                }
            }
            if(text == "Sunny") {
                // No clouds, no rain. That means it's sunny!
                var material1 = new BABYLON.StandardMaterial("mat1", scene);
                material1.diffuseColor = new BABYLON.Color3(1, 1, 0);
                material1.specularColor = new BABYLON.Color3(1, 1, 0);
                material1.specularPower = 100;
                material1.emissiveColor = new BABYLON.Color3(1, 1, 0);
                sun = BABYLON.Mesh.CreateSphere("sun", 90.0, 5.0, scene);
                sun.material = material1;
                sun.position = new BABYLON.Vector3(-10, 3, 0);
            }
        }
        
    </script>
</body>
</html>
